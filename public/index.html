<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Compression Tool</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f6fa; color: #333; display: flex; flex-direction: column; align-items: center; padding: 40px; }
    h1 { margin-bottom: 20px; }
    form { background: #fff; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
    input[type=file] { margin: 10px 0; }
    select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; transition: 0.3s; }
    button:hover { background-color: #45a049; }
    progress { width: 100%; height: 20px; border-radius: 10px; }
    #result { margin-top: 30px; width: 100%; max-width: 500px; }
    .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
    .download-link { text-decoration: none; color: #3498db; }
  </style>
</head>
<body>
  <h1>图片无损压缩工具</h1>
  <form id="uploadForm" enctype="multipart/form-data" method="post" action="/upload">
    <label>选择图片文件：</label>
    <input type="file" name="images" accept="image/*" multiple required />
    <label>输出格式：</label>
    <select name="format" required>
      <option value="webp">WebP（无损）</option>
      <option value="avif">AVIF（无损）</option>
    </select>
    <button type="submit">上传并压缩</button>
  </form>

  <div id="progressContainer" style="display:none; margin-top:20px; width:100%; max-width:500px;">
    <p>上传进度: <span id="uploadText">0%</span></p>
    <progress id="uploadBar" value="0" max="100"></progress>
    <p style="margin-top:10px;">压缩进度: <span id="compressionText">等待中...</span></p>
    <progress id="compressionBar" value="0" max="100"></progress>
  </div>

  <div id="result"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const progressContainer = document.getElementById('progressContainer');
    const uploadBar = document.getElementById('uploadBar');
    const uploadText = document.getElementById('uploadText');
    const compressionBar = document.getElementById('compressionBar');
    const compressionText = document.getElementById('compressionText');
    const result = document.getElementById('result');

    form.addEventListener('submit', e => {
      e.preventDefault();
      
      // 每次提交生成新的随机 ID
      const clientId = Math.random().toString(36).substring(2, 11);
      console.log('开始新的上传任务，客户端ID:', clientId);

      // 重置进度条
      progressContainer.style.display = 'block';
      uploadBar.value = 0;
      uploadText.textContent = '0%';
      compressionBar.value = 0;
      compressionBar.max = 100;
      compressionText.textContent = '正在连接服务器...';
      result.innerHTML = '';

      // 建立 SSE 连接以监听压缩进度
      const eventSource = new EventSource(`/events/${clientId}`);
      let isConnected = false;
      
      eventSource.onopen = () => {
        console.log('SSE 连接已建立');
        isConnected = true;
      };

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('收到服务器消息:', data);
        
        if (data.type === 'connected') {
          console.log('服务器确认连接并已准备好推送');
          // 连接建立后开始上传
          startUpload(clientId, eventSource);
        } else if (data.percentage !== undefined) {
          compressionBar.max = 100;
          compressionBar.value = data.percentage;
          compressionText.textContent = `${data.percentage}%`;
        }
      };


      eventSource.onerror = (err) => {
        console.error('SSE 连接错误:', err);
        if (!isConnected) {
            compressionText.textContent = '无法建立进度连接，尝试强制上传...';
            startUpload(clientId, eventSource);
        }
      };
    });

    function startUpload(clientId, eventSource) {
      const formData = new FormData(form);
      formData.append('clientId', clientId);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload', true);

      xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
          let percent = Math.round((e.loaded / e.total) * 100);
          uploadBar.value = percent;
          uploadText.textContent = percent + '%';
          if (percent === 100) {
              compressionText.textContent = '文件上传完成，正在压缩...';
          }
        }
      };

      xhr.onload = () => {
        console.log('上传请求完成，状态码:', xhr.status);
        setTimeout(() => eventSource.close(), 1000); // 略微延迟关闭以确保最后一条消息收到
        if (xhr.status === 200) {
          result.innerHTML = xhr.responseText.replace(/<li>/g, '<div class=\"card\">').replace(/<\/li>/g, '</div>').replace(/<ul>/g, '').replace(/<\/ul>/g, '');
          uploadBar.value = 100;
          uploadText.textContent = '100%';
          compressionText.textContent = '压缩流程已结束';
        } else {
          result.innerHTML = `<p style=\"color:red;\">服务请求失败，状态码：${xhr.status}</p>`;
        }
      };

      xhr.onerror = () => {
        eventSource.close();
        result.innerHTML = '<p style=\"color:red;\">网络错误，请重试。</p>';
      };

      xhr.send(formData);
    }

    // 实现点击下载后移除卡片
    result.addEventListener('click', e => {
      if (e.target.tagName === 'A' && e.target.href.includes('/download/')) {
        const card = e.target.closest('.card');
        if (card) {
          card.remove();
        }
      }
    });
  </script>



</body>
</html>
