<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Compression Tool</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f6fa; color: #333; display: flex; flex-direction: column; align-items: center; padding: 40px; }
    h1 { margin-bottom: 20px; }
    form { background: #fff; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
    input[type=file] { margin: 10px 0; }
    select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; transition: 0.3s; }
    button:hover { background-color: #45a049; }
    progress { width: 100%; height: 20px; border-radius: 10px; }
    #result { margin-top: 30px; width: 100%; max-width: 500px; }
    .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
    .download-link { text-decoration: none; color: #3498db; }
  </style>
</head>
<body>
  <h1>图片无损压缩工具</h1>
  <form id="uploadForm" enctype="multipart/form-data" method="post" action="/upload">
    <label>选择图片文件：</label>
    <input type="file" name="images" accept="image/*" multiple required />
    <label>输出格式：</label>
    <select name="format" required>
      <option value="webp">WebP（无损）</option>
      <option value="avif">AVIF（无损）</option>
    </select>
    <button type="submit">上传并压缩</button>
  </form>

  <div id="progressContainer" style="display:none; margin-top:20px; width:100%; max-width:500px;">
    <p>上传进度: <span id="progressText">0%</span></p>
    <progress id="progressBar" value="0" max="100"></progress>
  </div>

  <div id="result"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const result = document.getElementById('result');

    form.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(form);
      const xhr = new XMLHttpRequest();

      xhr.open('POST', '/upload', true);

      xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
          let percent = Math.round((e.loaded / e.total) * 100);
          progressContainer.style.display = 'block';
          progressBar.value = percent;
          progressText.textContent = percent + '%';
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          result.innerHTML = xhr.responseText.replace(/<li>/g, '<div class=\"card\">').replace(/<\/li>/g, '</div>').replace(/<ul>/g, '').replace(/<\/ul>/g, '');
          progressBar.value = 100;
          progressText.textContent = '100%';
        } else {
          result.innerHTML = `<p style=\"color:red;\">上传失败，状态码：${xhr.status}</p>`;
        }
      };

      xhr.onerror = () => {
        result.innerHTML = '<p style=\"color:red;\">上传出错，请重试。</p>';
      };

      xhr.send(formData);
    });
  </script>
</body>
</html>
